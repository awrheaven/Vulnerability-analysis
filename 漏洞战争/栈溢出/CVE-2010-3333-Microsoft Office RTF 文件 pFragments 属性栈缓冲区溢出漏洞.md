#### 漏洞介绍
Microsoft Office XP SP3,Office 2003 Sp3,Office 2007 Sp2 Office 2010等多个版本的Office软件中的open XML文件格式转换器存在栈溢出漏洞，主要是在处理RTF文件的‘pFragments’属性是存在栈溢出漏洞，导致任意代码执行

#### 漏洞分析

使用Metasploit生成的poc进行分析，启动winword,使用windbg附件程序，我们发现程序中断到如下的地址,这是因为复制数据太大，复制到edi不可写的地址，所以导致访问异常
```c++
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0000c8ac ebx=05000000 ecx=00000189 edx=00000000 esi=1104c294 edi=00190000
eip=30e9eb88 esp=00183d50 ebp=00183d88 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Common Files\Microsoft Shared\office11\mso.dll -
mso!Ordinal6426+0x64d:
30e9eb88 f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Microsoft Office\OFFICE11\WINWORD.EXE -
0:000> !address edi                                 
Failed to map Heaps (error 80004005)
Usage:                  MemoryMappedFile
Allocation Base:        00190000
Base Address:           00190000
End Address:            00194000
Region Size:            00004000
Type:                   00040000	MEM_MAPPED
State:                  00001000	MEM_COMMIT
Protect:                00000002	PAGE_READONLY
Mapped file name:       PageFile


```



```C++

30E9EB62   | 57              | push edi                               |
30E9EB63   | 8B7C24 0C       | mov edi,dword ptr ss:[esp+C]           |
30E9EB67   | 85FF            | test edi,edi                           |
30E9EB69   | 74 27           | je mso.30E9EB92                        |
30E9EB6B   | 8B4424 08       | mov eax,dword ptr ss:[esp+8]           |
30E9EB6F   | 8B48 08         | mov ecx,dword ptr ds:[eax+8]  //复制ecx         |
30E9EB72   | 81E1 FFFF0000   | and ecx,FFFF                           |
30E9EB78   | 56              | push esi                               |
30E9EB79   | 8BF1            | mov esi,ecx                            |
30E9EB7B   | 0FAF7424 14     | imul esi,dword ptr ss:[esp+14]         |
30E9EB80   | 0370 10         | add esi,dword ptr ds:[eax+10]          |
30E9EB83   | 8BC1            | mov eax,ecx                            |
30E9EB85   | C1E9 02         | shr ecx,2  //因为以DWORD为大小操作，所以需要除以4，右移2位，而ecx的数据是可以控制的，来自于POC的数据。                          
30E9EB88   | F3:A5           | rep movsd   //crash 地址 ，复制数据，复制数据大小由ecx控制
30E9EB8A   | 8BC8            | mov ecx,eax                            |
30E9EB8C   | 83E1 03         | and ecx,3                              |
30E9EB8F   | F3:A4           | rep movsb                              |
30E9EB91   | 5E              | pop esi                                |
30E9EB92   | 5F              | pop edi                                |
30E9EB93   | C2 0C00         | ret C                                  |




30F4CC5D   | 55              | push ebp                               |
30F4CC5E   | 8BEC            | mov ebp,esp                            |
30F4CC60   | 83EC 14         | sub esp,14                             |
30F4CC63   | 837D 18 00      | cmp dword ptr ss:[ebp+18],0            |
30F4CC67   | 57              | push edi                               |
30F4CC68   | 8BF8            | mov edi,eax                            |
30F4CC6A   | 0F84 B6291300   | je mso.3107F626                        |
30F4CC70   | 8B4F 08         | mov ecx,dword ptr ds:[edi+8]           |
30F4CC73   | 53              | push ebx                               |
30F4CC74   | 56              | push esi                               |
30F4CC75   | E8 92B4DDFF     | call mso.30D2810C                      |
30F4CC7A   | FF75 0C         | push dword ptr ss:[ebp+C]              |
30F4CC7D   | 8B70 64         | mov esi,dword ptr ds:[eax+64]          |
30F4CC80   | 8365 F8 00      | and dword ptr ss:[ebp-8],0             |
30F4CC84   | 8B06            | mov eax,dword ptr ds:[esi]             |
30F4CC86   | 8D4D F0         | lea ecx,dword ptr ss:[ebp-10]          |
30F4CC89   | 51              | push ecx                               |
30F4CC8A   | BB 00000005     | mov ebx,5000000                        |
30F4CC8F   | 56              | push esi                               |
30F4CC90   | 895D F4         | mov dword ptr ss:[ebp-C],ebx           |
30F4CC93   | FF50 1C         | call dword ptr ds:[eax+1C]  //调用 crash函数          |
```
![](../images/CVE-2010-3333_1.png)     

在函数0x30F4CC5D的栈大小为0x14, 根据计算我们需要复制大小为0x18的数据既可以覆盖返回地址，在返回地址处填入jmp esp 指令的地址即可。

![](../images/CVE-2010-3333_2.png)  
函数0x30F4CC5D返回时，会弹栈大小0x14,所以我们需要在返回地址后的0x14之后，布局shellcode。
```c++
30F4CD52   | 5B              | pop ebx                                |
30F4CD53   | 5F              | pop edi                                |
30F4CD54   | C9              | leave                                  |
30F4CD55   | C2 1400         | ret 14                                 |
```

![](../images/CVE-2010-3333_3.png)  
